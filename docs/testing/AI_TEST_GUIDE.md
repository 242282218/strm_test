# AI 测试指导文档 - 智能重命名夸克集成

## 🎯 测试目标
验证智能重命名功能的夸克云盘集成是否完整可用，包括文件浏览、递归扫描、智能分析和批量重命名。

---

## 📋 前置条件检查

### 1. 服务状态
```bash
# 后端应该运行在 8000 端口
curl http://localhost:8000/docs

# 前端应该运行在 3000 端口
curl http://localhost:3000
```

### 2. 配置检查
- 确认 `config.yaml` 中 `quark.cookie` 已配置
- 确认夸克账号有可访问的文件

---

## 🧪 测试用例

### TC1: 文件浏览器基础功能
**步骤**:
1. 访问 `http://localhost:3000/smart-rename`
2. 点击"浏览文件夹"按钮
3. 选择"夸克云盘"

**期望**:
- ✅ 弹出文件浏览器对话框
- ✅ 显示根目录文件列表
- ✅ 有面包屑导航："根目录"
- ✅ 文件列表显示名称、类型、大小、时间

**验证命令**:
```python
import requests
r = requests.get('http://localhost:8000/api/quark/browse?pdir_fid=0&page=1&size=10')
print(f"状态: {r.status_code}")
print(f"文件数: {len(r.json()['data']['items'])}")
```

---

### TC2: 目录导航
**步骤**:
1. 在文件列表中双击一个文件夹
2. 观察面包屑变化
3. 点击面包屑中的"根目录"

**期望**:
- ✅ 双击后进入子目录
- ✅ 面包屑添加新层级
- ✅ 文件列表更新为子目录内容
- ✅ 点击面包屑返回上级

---

### TC3: 文件夹选择
**步骤**:
1. 单击选中一个文件夹（蓝色高亮）
2. 点击"确定"按钮

**期望**:
- ✅ 对话框关闭
- ✅ 主页面显示："夸克云盘: /文件夹名"
- ✅ 成功提示："已选择云盘文件夹"

---

### TC4: 递归扫描（不勾选）
**步骤**:
1. 选择一个包含子文件夹的目录
2. 打开"高级选项"
3. **不勾选**"包含子文件夹"
4. 点击"开始分析"

**期望**:
- ✅ 只扫描当前目录的视频文件
- ✅ 不扫描子目录
- ✅ 提示："共发现 X 个媒体文件"

**验证点**:
- 对比勾选前后的文件数量差异

---

### TC5: 递归扫描（勾选）
**步骤**:
1. 选择同一个目录
2. **勾选**"包含子文件夹"
3. 点击"开始分析"

**期望**:
- ✅ 扫描当前目录及所有子目录
- ✅ 文件数量明显增加
- ✅ 后端日志显示："递归扫描完成，找到 X 个视频文件"

**验证命令**:
查看后端日志，应该看到：
```
开始扫描目录 xxx，递归=True
递归扫描完成，找到 X 个视频文件
```

---

### TC6: 智能分析预览
**步骤**:
1. 完成文件扫描后
2. 查看预览列表

**期望**:
- ✅ 显示原文件名
- ✅ 显示新文件名（符合Emby规范）
- ✅ 显示TMDB标题和年份
- ✅ 显示置信度（百分比）
- ✅ 显示媒体类型（电影/电视剧/动漫）

**关键字段**:
- `original_name`: 原始文件名
- `new_name`: 新文件名（如：`Show Name (2023)/Season 01/Show Name - S01E01.mp4`）
- `tmdb_title`: TMDB标题
- `overall_confidence`: 置信度（0-1）
- `needs_confirmation`: 是否需要确认

---

### TC7: 筛选功能
**步骤**:
1. 使用右上角筛选器
2. 分别选择：全部/待确认/已确认/已匹配

**期望**:
- ✅ "待确认"：只显示置信度低的项
- ✅ "已确认"：显示高置信度项
- ✅ "已匹配"：显示有TMDB ID的项

---

### TC8: 批量选择
**步骤**:
1. 勾选全选框
2. 取消部分项
3. 点击"执行重命名"

**期望**:
- ✅ 全选框勾选所有项
- ✅ 可以单独取消项
- ✅ 只对勾选的项执行重命名

---

### TC9: 执行重命名
**步骤**:
1. 选择少量文件（建议先测试1-2个）
2. 点击"执行重命名"
3. 确认对话框

**期望**:
- ✅ 显示确认对话框："确定要重命名 X 个文件吗？"
- ✅ 执行中显示进度
- ✅ 成功后显示统计："X 个成功，Y 个失败"
- ✅ 云盘中文件名确实修改

**验证**:
访问夸克云盘网页版，确认文件名已修改

---

### TC10: 错误处理
**步骤**:
1. 未选择文件夹，直接点击"开始分析"
2. 选择空文件夹
3. 网络中断时操作

**期望**:
- ✅ 提示："请先选择文件夹"
- ✅ 提示："该目录下没有找到视频文件（包含子目录）"
- ✅ 提示："加载文件列表失败，请检查网络连接"

---

## 🔍 关键验证点

### 后端日志检查
```bash
# 查看后端日志（最后50行）
tail -n 50 logs/quark_strm.log
```

**应该看到**:
- `开始扫描目录 xxx，递归=True/False`
- `递归扫描完成，找到 X 个视频文件`
- `找到 X 个视频文件，开始智能重命名分析`

### 浏览器控制台检查
按 F12 打开开发者工具，Console 选项卡应该看到：
```
[QuarkBrowser] 开始加载文件，参数: {...}
[QuarkBrowser] API 响应: {...}
[QuarkBrowser] 文件列表已设置: X 个文件
```

### 网络请求检查
Network 选项卡应该看到：
- `GET /api/quark/browse` - 200 OK
- `POST /api/quark/smart-rename-cloud` - 200 OK  
- `POST /api/quark/execute-cloud-rename` - 200 OK

---

## 📊 性能基准

| 操作 | 预期时间 |
|------|---------|
| 浏览目录（50个文件） | < 2秒 |
| 递归扫描（100个文件） | < 10秒 |
| 智能分析（50个文件） | < 30秒 |
| 执行重命名（10个文件） | < 5秒 |

---

## ⚠️ 已知限制

1. **最大文件数**: 递归扫描最多返回 1000 个文件
2. **递归深度**: 最多递归 10 层子目录
3. **API限流**: 每个目录扫描间隔 0.1 秒
4. **批量重命名**: 每批 10 个文件，批次间隔 0.5 秒

---

## ✅ 测试通过标准

- [ ] 所有10个测试用例通过
- [ ] 无控制台错误
- [ ] 后端日志无ERROR级别日志
- [ ] 实际云盘文件成功重命名
- [ ] 性能符合基准

---

## 🐛 常见问题排查

### 问题1: 加载文件列表失败
**原因**: Cookie 失效或网络问题
**解决**: 
1. 检查 `config.yaml` 中 cookie 是否有效
2. 访问测试页面：`http://localhost:3000/test-api.html`
3. 查看后端日志

### 问题2: 递归扫描没有效果
**原因**: 前端缓存
**解决**: Ctrl+Shift+R 强制刷新

### 问题3: 重命名失败
**原因**: 文件名冲突或权限问题
**解决**: 
1. 检查云盘中是否已有同名文件
2. 确认账号有修改权限

---

## 📝 测试报告模板

```
测试时间: YYYY-MM-DD HH:MM
测试人: AI Agent

通过用例: X/10
失败用例: [TC编号]
阻塞问题: [描述]

性能数据:
- 浏览50个文件: X秒
- 递归扫描100个文件: X秒
- 智能分析50个文件: X秒

备注: [其他发现]
```

---

**重要提示**: 测试前建议先在一个测试目录（包含少量文件）进行，确认功能正常后再用于生产数据。

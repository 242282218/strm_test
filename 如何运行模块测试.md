# 如何运行模块测试

本文档说明如何运行夸克STRM系统的模块测试。

## 测试资产清单

| 文件 | 类型 | 用途 |
|------|------|------|
| `模块测试矩阵.md` | 文档 | 测试用例清单与覆盖状态 |
| `tests/` | 目录 | pytest单元测试 |
| `scripts/smoke_api.py` | 脚本 | API冒烟测试 |
| `scripts/smoke_web.sh` | 脚本 | 前端构建测试 |

---

## 1. 后端单元测试 (pytest)

### 环境准备

```bash
# 安装测试依赖
pip install pytest pytest-asyncio httpx

# 确保项目依赖已安装
pip install -r requirements.txt
```

### 运行测试

```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_config.py
pytest tests/test_validators.py
pytest tests/test_schemas.py
pytest tests/test_services.py

# 运行特定测试用例
pytest tests/test_config.py::TestAppConfig::test_load_valid_config

# 显示详细输出
pytest -v

# 显示测试覆盖率（需安装pytest-cov）
pytest --cov=app --cov-report=term-missing
```

### 测试文件说明

| 文件 | 覆盖模块 | 对应测试矩阵 |
|------|----------|--------------|
| `test_config.py` | 配置加载、ConfigService | CORE-001/002, SVC-001/002 |
| `test_validators.py` | 路径/URL验证器 | CORE-003/004 |
| `test_schemas.py` | Pydantic Schema | MDL-001/002 |
| `test_services.py` | 各Service层 | SVC-003~SVC-014 |

### 最小环境示例

创建 `tests/fixtures/test_config.yaml`:

```yaml
database: test.db
log_level: DEBUG
quark:
  cookie: "test_cookie"
  root_id: "0"
tmdb:
  api_key: "test_key"
```

---

## 2. API冒烟测试 (smoke_api.py)

### 环境准备

```bash
# 安装依赖
pip install httpx

# 确保后端服务已启动
python -m uvicorn app.main:app --host 0.0.0.0 --port 8001
```

### 运行测试

```bash
# 基本用法（使用默认URL: http://127.0.0.1:8001）
python scripts/smoke_api.py

# 指定自定义URL
python scripts/smoke_api.py --base-url http://localhost:18000

# 或设置环境变量
export BASE_URL=http://localhost:18000
python scripts/smoke_api.py

# 显示详细输出
python scripts/smoke_api.py --verbose
```

### 测试覆盖

| 用例ID | 测试内容 | 预期结果 |
|--------|----------|----------|
| SMK-001 | GET / | 200/307/308 |
| API-003 | GET /health | 200 + status字段 |
| SMK-002 | GET /nonexistent | 404 |
| SMK-003 | GET /api/quark/files/0 (无Cookie) | 401/403 (非500) |
| SMK-004 | POST /api/transfer (无效JSON) | 422 (非500) |
| API-006 | GET /config (无API Key) | 401/403 |

### 退出码

- `0` - 所有测试通过
- `1` - 有测试失败
- 其他 - 执行错误

---

## 3. 前端构建测试 (smoke_web.sh)

### 环境要求

- Node.js 20+ (必须)
- npm (必须)

### 运行测试

**Linux/macOS:**
```bash
# 添加执行权限（首次运行）
chmod +x scripts/smoke_web.sh

# 运行测试
./scripts/smoke_web.sh

# 显示详细输出
./scripts/smoke_web.sh --verbose
```

**Windows (PowerShell):**
```powershell
# 使用Git Bash或WSL运行
bash scripts/smoke_web.sh

# 或使用PowerShell直接运行npm命令
cd web
npm ci
npm run type-check
npm run build-only
```

### 测试步骤

1. **环境检查** - 验证Node.js版本 >= 20
2. **依赖安装** - 运行 `npm ci`
3. **类型检查** - 运行 `npm run type-check`
4. **构建验证** - 运行 `npm run build-only`
5. **Lint检查** - 运行 `npm run lint`（非阻断）

### 退出码

- `0` - 构建成功
- `1` - 构建失败
- `2` - 环境检查失败

---

## 4. CI/CD 集成示例

### GitHub Actions

```yaml
name: Module Tests

on: [push, pull_request]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt
      - run: pip install pytest pytest-asyncio httpx
      - run: pytest
      - run: python scripts/smoke_api.py
        env:
          BASE_URL: http://localhost:8001
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: ./scripts/smoke_web.sh
```

---

## 5. 测试覆盖状态

### 已覆盖模块

- ✅ API路由挂载
- ✅ 健康检查端点
- ✅ 配置加载与验证
- ✅ 路径/URL验证器
- ✅ Pydantic Schema
- ✅ Cloud Drive Service
- ✅ Task Queue Service
- ✅ Transfer Service
- ✅ Emby Proxy Service
- ✅ STRM Service
- ✅ Scrape Service
- ✅ 前端构建流程

### 暂无法覆盖（需集成测试）

| 模块 | 原因 |
|------|------|
| WebDAV服务 | 需要WSGIDav服务器环境 |
| 通知服务 | 需要真实外部API凭证 |
| 定时任务 | 需要运行中的事件循环 |
| Redis缓存 | 需要Redis实例 |
| AI解析服务 | 需要真实AI API Key |
| 播放代理Hook | 依赖Emby Webhook事件 |

---

## 6. 故障排查

### pytest导入错误

```bash
# 确保在项目根目录运行
cd /path/to/quark_strm
pytest

# 或添加项目路径
export PYTHONPATH=/path/to/quark_strm:$PYTHONPATH
pytest
```

### smoke_api.py连接失败

```bash
# 检查服务是否运行
curl http://127.0.0.1:8001/health

# 检查端口配置
python scripts/smoke_api.py --base-url http://localhost:YOUR_PORT
```

### smoke_web.sh权限错误

```bash
# 添加执行权限
chmod +x scripts/smoke_web.sh

# 或使用bash直接运行
bash scripts/smoke_web.sh
```

### Node.js版本不足

```bash
# 检查版本
node --version  # 需要 >= 20

# 使用nvm切换版本
nvm use 20
# 或
nvm install 20
```

---

## 7. 扩展测试

如需添加新测试：

1. **pytest单元测试**: 在 `tests/` 目录添加 `test_*.py` 文件
2. **API冒烟测试**: 在 `scripts/smoke_api.py` 的 `APISmokeTester` 类添加方法
3. **前端测试**: 修改 `scripts/smoke_web.sh` 添加新检查步骤

更新测试矩阵：修改 `模块测试矩阵.md`

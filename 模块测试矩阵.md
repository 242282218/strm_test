# 模块测试矩阵

## 测试策略
- 所有外部依赖（TMDB/Quark/Emby）必须Mock
- 测试分为：单元测试（pytest）、API冒烟测试（smoke_api.py）、前端构建测试（smoke_web.sh）
- 每个模块至少1条正向+1条负向用例

---

## 1. API层测试

### 1.1 路由挂载验证
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| API-001 | 正向 | `app/main.py` | 启动FastAPI应用 | 所有router正确挂载，无重复路由 | 无 | 启动报错/路由冲突 |
| API-002 | 负向 | `app/main.py` | 重复挂载同名路由 | 抛出路由冲突异常 | 无 | 未抛出异常 |

### 1.2 健康检查端点
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| API-003 | 正向 | `GET /health` | 无 | 返回200，包含status/uptime/version | 无 | 非200/字段缺失 |
| API-004 | 负向 | `GET /health` | 应用未启动 | 连接拒绝 | 无 | 返回200 |

### 1.3 配置端点
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| API-005 | 正向 | `GET /config` | 有效API Key | 返回脱敏配置 | TEST_API_KEY | 401/敏感信息泄露 |
| API-006 | 负向 | `GET /config` | 无效API Key | 返回401 Unauthorized | 无 | 返回200 |

---

## 2. Service层测试

### 2.1 配置服务（Config Service）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-001 | 正向 | `ConfigService.get_config()` | 有效config.yaml路径 | 返回AppConfig实例 | 测试配置文件 | 返回None/异常 |
| SVC-002 | 负向 | `ConfigService.get_config()` | 不存在的配置文件路径 | 抛出FileNotFoundError | 无 | 未抛出异常 |

### 2.2 云盘服务（Cloud Drive Service）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-003 | 正向 | `CloudDriveService.create_drive()` | 有效CloudDriveCreate | 创建成功，返回drive对象 | 内存数据库 | 创建失败/返回None |
| SVC-004 | 负向 | `CloudDriveService.create_drive()` | 空cookie | 抛出ValidationError | 无 | 创建成功 |

### 2.3 任务队列服务（Task Queue Service）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-005 | 正向 | `TaskService.create_task()` | 有效TaskCreate | 任务创建成功，状态pending | 内存数据库 | 创建失败 |
| SVC-006 | 负向 | `TaskService.cancel_task()` | 不存在的task_id | 返回False | 无 | 返回True/异常 |

### 2.4 刮削服务（Scrape Service）
| 用例ID | 类型 | 入口 | 输入 | 输入 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-007 | 正向 | `ScrapeService.create_job()` | 有效target_path | 创建ScrapeJob，返回job对象 | Mock TMDB, 内存数据库 | 创建失败 |
| SVC-008 | 负向 | `ScrapeService.create_job()` | 非法路径（包含..） | 抛出ValidationError | 无 | 创建成功 |

### 2.5 STRM服务（STRM Service）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-009 | 正向 | `StrmService.scan_directory()` | 有效remote_path, local_path | 返回扫描结果字典 | Mock QuarkService | 返回None/异常 |
| SVC-010 | 负向 | `StrmService.scan_directory()` | 空路径 | 抛出ValidationError | 无 | 执行成功 |

### 2.6 转存服务（Transfer Service）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-011 | 正向 | `TransferService._extract_pwd_id()` | 有效分享URL | 返回pwd_id | 无 | 返回None |
| SVC-012 | 负向 | `TransferService._extract_pwd_id()` | 无效URL格式 | 返回None | 无 | 返回非None |

### 2.7 Emby代理服务（Emby Proxy Service）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SVC-013 | 正向 | `EmbyProxyService.proxy_item()` | 有效item_id | 返回代理URL | Mock Emby API | 返回None |
| SVC-014 | 负向 | `EmbyProxyService.proxy_item()` | 空item_id | 抛出ValueError | 无 | 返回URL |

---

## 3. 模型层测试

### 3.1 Pydantic Schema验证
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| MDL-001 | 正向 | `CloudDriveCreate` | 有效name/drive_type/cookie | 实例创建成功 | 无 | 抛出ValidationError |
| MDL-002 | 负向 | `CloudDriveCreate` | 空name | 抛出ValidationError | 无 | 创建成功 |

### 3.2 SQLAlchemy模型
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| MDL-003 | 正向 | `Task`模型 | 有效task_type/status | 数据库插入成功 | 内存数据库 | 插入失败 |
| MDL-004 | 负向 | `Task`模型 | 超长task_type(>255) | 截断或报错 | 无 | 静默截断 |

---

## 4. 核心功能测试

### 4.1 配置加载（Settings）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| CORE-001 | 正向 | `AppConfig.from_yaml()` | 有效YAML配置 | 返回配置实例 | 测试配置文件 | 解析失败 |
| CORE-002 | 负向 | `AppConfig.from_yaml()` | 无效YAML格式 | 抛出yaml.YAMLError | 无 | 未抛出异常 |

### 4.2 验证器（Validators）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| CORE-003 | 正向 | `validate_path()` | 合法路径"/test/path" | 返回验证后路径 | 无 | 抛出异常 |
| CORE-004 | 负向 | `validate_path()` | 路径包含".." | 抛出InputValidationError | 无 | 返回路径 |

### 4.3 路径安全（Path Security）
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| CORE-005 | 正向 | `safe_makedirs()` | 合法目录路径 | 目录创建成功 | 临时目录 | 创建失败 |
| CORE-006 | 负向 | `safe_makedirs()` | 路径包含"/etc/passwd" | 抛出PathSecurityError | 无 | 创建成功 |

---

## 5. 前端测试

### 5.1 构建验证
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| WEB-001 | 正向 | `npm run build` | 完整源码 | 生成dist目录，无错误 | Node.js 20+ | 构建失败/错误输出 |
| WEB-002 | 负向 | `npm run build` | 删除关键组件后构建 | 构建失败 | Node.js 20+ | 构建成功 |

### 5.2 TypeScript类型检查
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| WEB-003 | 正向 | `npm run type-check` | 完整源码 | 无类型错误 | Node.js 20+ | 类型错误 |
| WEB-004 | 负向 | `npm run type-check` | 添加类型错误代码 | 报告类型错误 | Node.js 20+ | 无错误 |

---

## 6. API冒烟测试（smoke_api.py）

### 6.1 基础连通性
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SMK-001 | 正向 | `GET /` | 无 | 返回200或前端index.html | FastAPI运行 | 非200/连接失败 |
| SMK-002 | 负向 | `GET /nonexistent` | 无 | 返回404 | FastAPI运行 | 返回200 |

### 6.2 错误处理验证
| 用例ID | 类型 | 入口 | 输入 | 预期 | 依赖 | 失败信号 |
|--------|------|------|------|------|------|----------|
| SMK-003 | 正向 | `GET /api/quark/files/0` | 无Cookie | 返回401/403结构化错误 | FastAPI运行 | 500错误/无结构 |
| SMK-004 | 负向 | `POST /api/transfer` | 无效JSON | 返回422 Validation Error | FastAPI运行 | 500错误 |

---

## 7. 覆盖状态汇总

| 模块 | 测试类型 | 覆盖状态 | 备注 |
|------|----------|----------|------|
| API路由挂载 | 单元测试 | 已覆盖 | API-001/002 |
| 健康检查 | API冒烟 | 已覆盖 | SMK-001/002, API-003/004 |
| 配置服务 | 单元测试 | 已覆盖 | SVC-001/002, CORE-001/002 |
| 云盘服务 | 单元测试 | 已覆盖 | SVC-003/004, MDL-001/002 |
| 任务队列 | 单元测试 | 已覆盖 | SVC-005/006, MDL-003/004 |
| 刮削服务 | 单元测试 | 已覆盖 | SVC-007/008 |
| STRM服务 | 单元测试 | 已覆盖 | SVC-009/010 |
| 转存服务 | 单元测试 | 已覆盖 | SVC-011/012 |
| Emby代理 | 单元测试 | 已覆盖 | SVC-013/014 |
| 验证器 | 单元测试 | 已覆盖 | CORE-003/004 |
| 路径安全 | 单元测试 | 已覆盖 | CORE-005/006 |
| 前端构建 | 脚本测试 | 已覆盖 | WEB-001/002/003/004 |
| API冒烟 | 脚本测试 | 已覆盖 | SMK-001/002/003/004 |

---

## 8. 暂无法覆盖模块（原因说明）

| 模块 | 原因 | 建议 |
|------|------|------|
| WebDAV服务 | 依赖WSGIDav，需要完整HTTP服务器环境 | 集成测试阶段覆盖 |
| 通知服务(Telegram/WeChat) | 需要真实外部API凭证 | Mock测试已在SVC层覆盖基础逻辑 |
| 定时任务(Cron) | APScheduler需要运行中的事件循环 | 单独测试文件测试调度逻辑 |
| 缓存服务(Redis) | 需要Redis实例 | 使用fakeredis或内存缓存替代 |
| AI解析服务 | 需要真实AI API Key | Mock测试覆盖参数验证 |
| 播放代理Hook | 依赖Emby Webhook事件 | 单元测试覆盖事件解析逻辑 |
